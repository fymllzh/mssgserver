
function selectOption(task_id, k){
    var key = "#modal-dialog" + k + "-"
    $(key+task_id).show();
    //var top =$("#selectbtn-"+task_id).offsetTop;
    //var divcss = {
    //top: top+'px',
    //};
    //$("#modal-dialog-"+task_id).css(divcss);
}
function closeOption(task_id, k){
    var key = "#modal-dialog" + k + "-"
    $(key+task_id).hide();
}

function execute(task_action, task_id, host_ids) {
    var appUrl = "/api/task/operate?task_action="+task_action+"&task_id="+task_id+"&host_ids="+host_ids;
    $.ajax({
        url: appUrl,
        method: "POST",
        async: false,
    }).done(function (res) {
        if (res.errno == 0) {
            $.apolloTip({
                refresh: true,
                tip: res.message + "，1秒内自动关闭",
                closeTime: 1000
            });
            //return location.replace(location);
        } else {
            var tpl;
            tpl = '';
            tpl += '<div style="padding:5px 20px">';
            tpl += '<p style="font-weight: bold;color: red;">任务下发结果：' + res.message + '</p>';
            for (var d in res.detail) {
                var color = "red";
                if (res.detail[d].result == '') {
                    res.detail[d].result = '成功';
                    var color = "green";
                }
                tpl += "<li>" + res.detail[d].host_name + " [" + res.detail[d].ip + "] " + ": <font style='color: " + color + "'>"
                    + res.detail[d].result + "</font></li>";
            }
            tpl += '</div>';

            return $(tpl).dialog({
                slow: 'slide',
                title: '任务错误',
                width: 600,
                height: 400,
                open: function (event, ui) {
                    $(this).bind('keypress', function (event) {
                        if (event.keyCode === $.ui.keyCode.ENTER) {
                            $(this).dialog('close');
                            return false;
                        }
                    });
                },
                buttons: {
                    '关闭': function () {
                        return $(this).dialog('close');
                    }
                }
            });
        }
    });
}

function runTask(task_action,task_id, group_id){
    if(task_action == 2){
        var tpl = "";
        tpl += '<div style="padding:5px 20px">';
        tpl += '<p style="color: red;font-size: 25px;font-weight: 800;">确定要下线此任务吗?</p>';
        tpl += '</div>';
        $(tpl).dialog({
            slow: 'slide',
            title: '下线任务提示',
            zIndex : 1030,
            width: 320,
            height: 220,
            open: function (event, ui) {
                $(this).bind('keypress', function (event) {
                    if (event.keyCode === $.ui.keyCode.ENTER) {
                        $('.ui-dialog-buttonpane button').first().click();
                        return false;
                    }
                });
            },
            buttons: {
                '确定': function () {
                    hostList(task_action, task_id, group_id);
                    return $(this).dialog('close');
                },
                '取消': function () {
                    return $(this).dialog('close');
                }
            }
        });
    }else {
        hostList(task_action, task_id, group_id);
    }
}

function distributeTask(task_id, env){
    if (env == 2) {
        alert('生产环境暂未实现');
        return;
    }
    var tpl = "";
    tpl += '<div style="padding:5px 20px">';
    // tpl += '<p style="color: red;font-size: 20px;font-weight: 800;">任务一旦发布，会直接在对应环境上线</p>';
    tpl += '<p style="color: red;font-size: 20px;font-weight: 800;">任务发布后，需要登录到对应的环境手动上线</p>';
    tpl += '<p style="font-size: 15px;font-weight: 800;">确定发布此任务吗?</p>';
    tpl += '</div>';
    $(tpl).dialog({
        slow: 'slide',
        title: '任务发布提示',
        zIndex : 1030,
        width: 420,
        height: 220,
        open: function (event, ui) {
            $(this).bind('keypress', function (event) {
                if (event.keyCode === $.ui.keyCode.ENTER) {
                    $('.ui-dialog-buttonpane button').first().click();
                    return false;
                }
            });
        },
        buttons: {
            '确定': function () {
                doDistributeTask(task_id, env)
                return $(this).dialog('close');
            },
            '取消': function () {
                return $(this).dialog('close');
            }
        }
    });
}

function doDistributeTask(task_id, env) {
    closeOption(task_id, 2);
    var appUrl = "/api/task/distribute?task_id="+task_id+"&env="+env;
    $.ajax({
        url: appUrl,
        method: "POST",
        async: false,
    }).done(function (res) {
        if (res.errno == 0) {
            $.apolloTip({
                refresh: true,
                tip: res.message + "，1秒内自动关闭",
                closeTime: 1000
            });
        } else {
            $.apolloTip({
                refresh: false,
                tip: res.message,
            });
        }
    });
}

function retry(code){

    var api, tpl;
    api = $('#api_'+code).val();
    var task_id = $('#task_id_'+code).val();
    var ip = $('#ip_'+code).val();
    var action = $('#action_'+code).val();
    var funtion = $('#function_'+code).val();
    var rpc_action = $('#rpc_action_'+code).val();

    $.ajax({
        url: api,
        data: {
            "task_id": task_id,
            "ip": ip,
            "action": action,
            "funtion": funtion,
            "rpc_action": rpc_action,
        },
        dataType: "json",
        type: "POST",
        traditional: true,
        success: function (msg){
            if(msg.errno > 0){
                $.apolloTip({
                    refresh: false,
                    tip: msg.message,
                });
            }else {
                $.apolloTip({
                    refresh: false,
                    tip: msg.message,
                });
            }
        },
        error : function() {
            alert("网络异常");
        }
    });
}

function hostList(task_action, task_id, group_id) {
    closeOption(task_id, 1);
    // 移除所有已经存在的复选框
    $('.task-host-item').remove();

    title = '任务ID : '+task_id+' 机器列表';
    $.ajax({
        url: "/api/hostgroup/hosts",
        data: {
            "group_id": group_id
        },
        dataType: "json",
        type: "get",
        success: function (msg){
            var data = msg.data;
            var hostips = [];
            tpl = '';
            tpl += '<div style="padding:5px 20px">';
            tpl += '<p><label><input type="checkbox" id="task-host-checkbox">&nbsp;全选</input></label></p>';
            
            var datamap = [];
            for(i in data) {
                datamap[data[i].env_name] = [];
                datamap[data[i].env_name].push(data[i]);
            }
            
            for(env in datamap) {
                data = datamap[env];
                tpl += "<div style='font-weight:bold;margin-bottom:5px;'>环境：" + env + "</div>";
                for(i in data) {
                    tpl += '<p style="margin:0px;"><label><input type="checkbox" class="task-host-item" value="'+ data[i].host_id +'">&nbsp;'+ data[i].host_ip + " -- " +data[i].host_name + '</input></label></p>';
                }
                tpl += "<div style='height:5px;'><hr></div>";
            }

            tpl += '</div>';

            return $(tpl).dialog({
                slow: 'slide',
                title: title,
                width: 400,
                height: 500,
                open: function (event, ui) {
                    $(this).bind('keypress', function (event) {
                        if (event.keyCode === $.ui.keyCode.ENTER) {
                            $('.ui-dialog-buttonpane button').first().click();
                            return false;
                        }
                    });
                },
                buttons: {
                    '确认': function () {
                        var host_ids = [];
                        $('.task-host-item:checked').each(function (index, item) {
                            host_ids.push($(this).val());
                        })
                        if (host_ids.length == 0) {
                            alert("请选择机器！");
                            return;
                        }
                        execute(task_action, task_id, host_ids);
                        return $(this).dialog('close');
                    },
                    '取消': function () {
                        return $(this).dialog('close');
                    }
                }
            });
        },
        error:function() {
            alert("网络异常");
        }
    });
}

$(document).on("change", '#task-host-checkbox', (function () {
    $('.task-host-item').prop('checked', $(this).prop('checked'));
}));

(function() {
    $(function() {
        var operate;
        $('.delete').click(function() {
            return operate($(this), 'destroy');
        });

        $('.detail').click(function(){
            var param, tpl, title;
            param = $(this).data('param');
            
            title = '任务ID : '+param.task_id+' 机器详细';
            group_id = param.group_id;
            $.ajax({
                url: "/api/hostgroup/hosts",
                data: {
                    "group_id": param.group_id,
                },
                dataType: "json",
                type: "get",
                success: function (msg){
                    var data = msg.data;
                    var hostips = [];
                    for(i in data) {
                        hostips.push(data[i].host_ip + " -- "+data[i].host_name)
                    }
                    tpl = '';
                    tpl += '<div style="padding:5px 20px">';
                    tpl += '<form action="" method="">';
                    tpl += '<br><p>'+ hostips.join("<br/>")+'</p><br>';
                    tpl += '</form>';
                    tpl += '</div>';
        
                    return $(tpl).dialog({
                        slow: 'slide',
                        title: title,
                        width: 400,
                        height: 500,
                        open: function (event, ui) {
                            $(this).bind('keypress', function (event) {
                                if (event.keyCode === $.ui.keyCode.ENTER) {
                                    $('.ui-dialog-buttonpane button').first().click();
                                    return false;
                                }
                            });
                        },
                        buttons: {
                            '确认': function () {
                                return $(this).dialog('close');
                            },
                            '取消': function () {
                                return $(this).dialog('close');
                            }
                        }
                    });
                },
                error:function() {
                    alert("网络异常");
                }
            });
        });

        $('.check').click(function(){
            var param, tpl, title, api;
            param = $(this).data('param');
            api = $(this).data('api');

            $.ajax({
                url: "/api/task/view",
                data: {
                    "id": param.id,
                    "type" : "1",
                },
                dataType: "json",
                type: "get",
                success: function (msg){

                    var data = msg.data;

                    tpl = '';
                    tpl += '<div style="padding:5px 20px">';
                    tpl += '<form action="" method="">';

                    tpl += '<div class="form-group">';
                    tpl += '<label>任务名称:</label>';
                    tpl += '<input type="text" class="form-control" readonly="readonly" disabled value="'+data.task_name+'">';
                    tpl += '</div>';

                    tpl += '<div class="form-group">';
                    tpl += '<label>任务等级:</label>';
                    if(data.task_level == 1){
                        tpl += '<input type="text" class="form-control" readonly="readonly" disabled value="一级任务">';
                    }else if(data.task_level == 2){
                        tpl += '<input type="text" class="form-control" readonly="readonly" disabled value="二级任务">';
                    }else if(data.task_level == 3){
                        tpl += '<input type="text" class="form-control" readonly="readonly" disabled value="三级任务">';
                    }
                    tpl += '</div>';

                    tpl += '<div class="form-group">';
                    tpl += '<label>任务分组:</label>';
                    tpl += '<input type="text" class="form-control" readonly="readonly" disabled value="'+data.task_name+'">';
                    tpl += '</div>';

                    tpl += '<div class="form-group">';
                    tpl += '<label>报警邮箱:</label>';
                    tpl += '<br>RD邮箱:<input type="text" class="form-control" readonly="readonly" disabled value="'+data.alarm_email+'">';
                    tpl += 'Leader邮箱:<input type="text" class="form-control" readonly="readonly" disabled value="'+data.alarm_email_leader+'">';
                    tpl += 'OP邮箱:<input type="text" class="form-control" readonly="readonly" disabled value="'+data.alarm_email_op+'">';
                    tpl += '</div>';

                    tpl += '<div class="form-group">';
                    tpl += '<label>运行失败次数:</label>';
                    tpl += '<br>RD接收:<input type="text" class="form-control" readonly="readonly" disabled value="'+data.run_fail_num+'">';
                    tpl += 'Leader接收:<input type="text" class="form-control" readonly="readonly" disabled value="'+data.run_fail_num_leader+'">';
                    tpl += 'OP接收:<input type="text" class="form-control" readonly="readonly" disabled value="'+data.run_fail_num_op+'">';
                    tpl += '</div>';

                    tpl += '<div class="form-group">';
                    tpl += '<label>运行命令:</label>';
                    tpl += '<textarea rows="5" class="form-control" readonly="readonly" disabled cols="10">'+data.run_command+'</textarea>'
                    tpl += '</div>';

                    tpl += '<div class="form-group">';
                    tpl += '<label>调度时间:</label>';
                    tpl += '<input type="text" class="form-control" readonly="readonly" disabled value="'+data.crontab_time+'">';
                    tpl += '</div>';

                    tpl += '<div class="form-group">';
                    tpl += '<label>执行账号:</label>';
                    tpl += '<input type="text" class="form-control" readonly="readonly" disabled value="'+data.run_user+'">';
                    tpl += '</div>';

                    tpl += '<div class="form-group">';
                    tpl += '<label>服务节点:</label>';
                    tpl += '<input type="text" class="form-control" readonly="readonly" disabled value="'+data.service_node+'">';
                    tpl += '</div>';

                    tpl += '<div class="form-group">';
                    tpl += '<label>屏蔽机器:</label>';
                    tpl += '<input type="text" class="form-control" readonly="readonly" disabled value="'+data.shield_host_list+'">';
                    tpl += '</div>';

                    tpl += '<div class="form-group">';
                    tpl += '<label>运行成功判断条件:</label>';
                    tpl += '<input type="text" class="form-control" readonly="readonly" disabled value="'+data.run_condition+'">';
                    tpl += '</div>';

                    tpl += '<div class="form-group">';
                    tpl += '<label>等待超时时间:</label>';
                    tpl += '<input type="text" class="form-control" readonly="readonly" disabled value="'+data.wait_timeout_time+'">';
                    tpl += '</div>';

                    tpl += '<div class="form-group">';
                    tpl += '<label>运行超时时间:</label>';
                    tpl += '<input type="text" class="form-control" readonly="readonly" disabled value="'+data.run_timeout_time+'">';
                    tpl += '</div>';

                    tpl += '<div class="form-group">';
                    tpl += '<label>管理者:</label>';
                    tpl += '<input type="text" class="form-control" readonly="readonly" disabled value="'+data.manager+'">';
                    tpl += '</div>';


                    tpl += '</form>';
                    tpl += '</div>';

                    verifyApi = '/api/task/verify';

                    return $(tpl).dialog({
                        slow: 'slide',
                        title: '任务审核',
                        width: 700,
                        height: 700,
                        open: function (event, ui) {
                            $(this).bind('keypress', function (event) {
                                if (event.keyCode === $.ui.keyCode.ENTER) {
                                    $('.ui-dialog-buttonpane button').first().click();
                                    return false;
                                }
                            });
                        },
                        buttons: {
                            '通过': function () {
                                param['auth'] = 2;
                                return $.apolloAjaxTip({
                                    url: verifyApi,
                                    data: param,
                                    type: 'POST',
                                    closeTime: 1500
                                });
                            },
                            '不通过': function () {
                                param['auth'] = 3;
                                return $.apolloAjaxTip({
                                    url: verifyApi,
                                    data: param,
                                    type: 'POST',
                                    closeTime: 1500
                                });
                            },
                            '取消': function () {
                                return $(this).dialog('close');
                            }
                        }
                    });
                },
                error : function() {
                    alert("网络异常");
                }
            });
        });

        $('.operate').click(function(){
            var api, param, tpl, title;
            param = $(this).data('param');
            api = $(this).data('api');

            tpl = '';
            tpl += '<br><a href="" onclick="'+$(this).dialog('close')+'"></a><br>';
            tpl += '</div>';

            return $(tpl).dialog({
                slow: 'slide',
                title: title,
                width: 200,
                height: 240,
                open: function (event, ui) {
                    $(this).bind('keypress', function (event) {
                        if (event.keyCode === $.ui.keyCode.ENTER) {
                            $('.ui-dialog-buttonpane button').first().click();
                            return false;
                        }
                    });
                },
            });

        });

        return operate = function(opObj, method) {
            var param, tpl;
            param = opObj.data('param');
            tpl = '';
            tpl += '<div style="padding:5px 20px">';
            tpl += '<form method="POST" action="/api/task/delete">';
            tpl += '<div class="well">';
            tpl += '<p>确认 ' + opObj.text() + '? </p>';
            tpl += '</div>';
            tpl += '<input type="hidden" value="' + param.id + '" name="id"/>';
            tpl += '</form>';
            tpl += '</div>';
            return apollo.formDialog(tpl, {
                dialog: {
                    title: opObj.text()
                }
            });
        };


    });
}).call(this);

