
function retry(code){

    var api, tpl;
    api = $('#api_'+code).val();
    var task_id = $('#task_id_'+code).val();
    var ip = $('#ip_'+code).val();
    var action = $('#action_'+code).val();
    var funtion = $('#function_'+code).val();
    var rpc_action = $('#rpc_action_'+code).val();

    $.ajax({
        url: api,
        data: {
            "task_id": task_id,
            "ip": ip,
            "action": action,
            "funtion": funtion,
            "rpc_action": rpc_action,
        },
        dataType: "json",
        type: "POST",
        traditional: true,
        success: function (msg){
            if(msg.errno > 0){
                $.apolloTip({
                    refresh: false,
                    tip: msg.message,
                });
            }else {
                $.apolloTip({
                    refresh: false,
                    tip: msg.message,
                });
            }
        },
        error : function() {
            alert("网络异常");
        }
    });
}

$(function(){
    $('.form-inline').ajaxForm({
        success: function(res) {
            if(res.errno == 0){
                alert(res.message);
                return window.location.href = "/cttask/";
            }else{
                alert(res.message);
            }
        }
    }, 'json');

    $("#choose_host_group_input").bind("click", function(event) {
        $("#choose_host_group").show();
    });
    $("#group_close").bind("click", function(event) {
        $("#choose_host_group").hide();
    });


    //表单
    $('.form-horizontal').ajaxForm({
        success: function(res) {
            if(res.errno == 0){
                $.apolloTip({
                    refresh: true,
                    tip: res.message,
                    closeTime: 1500
                });
                return window.location.href = "/html/task";
            }else if(res.errno == 22001){
                var tpl;
                var data = res.data;
                tpl = '';
                tpl += '<div style="padding:5px 20px">';
                tpl += '<p>'+res.message+'</p>';

                $.each(data,function(index,value) {

                    tpl += '<div class="form-group">';
                    tpl += index+'&nbsp;&nbsp;&nbsp;&nbsp;';
                    var c = "'"+value.code+"'";
                    tpl += '<a class="btn btn-info" href="javascript:void(0);" onclick="retry('+c+')">重试</a>';
                    tpl += '<input type="hidden" id="api_'+value.code+'" value="/html/task/retry">';
                    tpl += '<input type="hidden" id="task_id_'+value.code+'" value="'+value.task.args.taskId+'">';
                    tpl += '<input type="hidden" id="ip_'+value.code+'" value="'+index+'">';
                    tpl += '<input type="hidden" id="action_'+value.code+'" value="'+value.action+'">';
                    tpl += '<input type="hidden" id="function_'+value.code+'" value="'+value.task.function+'">';
                    tpl += '<input type="hidden" id="rpc_action_'+value.code+'" value="'+value.task.action+'">';
                    tpl += '</div>';

                });

                tpl += '</div>';

                return $(tpl).dialog({
                    slow: 'slide',
                    title: '任务错误',
                    width: 800,
                    height: 'auto',
                    open: function (event, ui) {
                        $(this).bind('keypress', function (event) {
                            if (event.keyCode === $.ui.keyCode.ENTER) {
                                $('.ui-dialog-buttonpane button').first().click();
                                return false;
                            }
                        });
                    },
                    buttons: {
                        '取消': function () {
                            return $(this).dialog('close');
                        }
                    }
                });
            }else{
                return $.apolloTip({
                    refresh: false,
                    tip: res.message,
                    closeTime: 1500
                });
            }
        }
    }, 'json');

    //邮箱级别
    $('#task_level').change(function(){
        var optionValue = $(this).children('option:selected').val();
        var alarm_email_op = $('#alarm_email_op');
        var alarm_email_op_label = $('#alarm_email_op_label');
        var run_fail_num_op_fail = $('#run_fail_num_op_fail');
        var run_fail_num_op_label = $('#run_fail_num_op_label');
        if(optionValue == 3){
            alarm_email_op.hide();
            run_fail_num_op_fail.hide();
            alarm_email_op_label.hide();
            run_fail_num_op_label.hide();
        }else {
            alarm_email_op.show();
            run_fail_num_op_fail.show();
            alarm_email_op_label.show();
            run_fail_num_op_label.show();
        }
    });

    //显示屏蔽机器页面
    $("#shield_host").click(function() {

        var service_node = $('#service_node').val();
        if(service_node == ''){
            $.apolloTip({
                refresh: false,
                tip: "请选择服务节点",
                closeTime: 3000
            });
        }else {
            $( "#dialog-form" ).dialog( "open" );
        }

    });

    //屏蔽机器
    $("#dialog-form").dialog({
        autoOpen: false,
        height: 500,
        width: 1000,
        draggable: true,
        resizable :true,
        open: function(event, ui) {
            $(this).bind("keypress", function(event) {
                if (event.keyCode === $.ui.keyCode.ENTER) {
                    $(".ui-dialog-buttonpane button").first().click();
                    return false;
                }
            });

            var service_node = $('#service_node').val();

            $.ajax({
                url:"/cttask/task/host",
                data:{
                    'group_id' : service_node,
                },
                type:'post',
                cache:false,
                dataType:'json',
                success:function(msg) {
                    //SelectorView
                    var sel = new SelectorView('sel_div');
                    sel.src.header = {
                        id			: 'Id',
                        name		: '机器名称',
                        name_cn		: 'IP地址'
                    };
                    sel.dst.header = {
                        id			: 'Id',
                        name		: '机器名称',
                        name_cn		: 'IP地址'
                    };
                    sel.src.dataKey = 'id';
                    sel.src.title = '机器列表';
                    sel.src.display.filter = true;
                    sel.src.display.pager = true;
                    sel.src.pager.size = 30;
                    sel.src.pager.maxButtons = 5;

                    sel.dst.dataKey = 'id';
                    sel.dst.title = '已选';
                    sel.dst.pager.size = 10000;
                    sel.dst.pager.maxButtons = 5;
                    sel.dst.display.pager = true;

                    sel.render();

                    var arr = [];
                    $(msg.list).each(function(index) {
                        arr.push({id: msg.list[index].id, name: msg.list[index].host_name, name_cn: msg.list[index].ip});
                    });
                    sel.src.addRange(arr);
                },
                error : function() {
                    alert("获取参数列表异常");
                }
            });
        },
        buttons: {
            "添加": function() {
                var str = '';
                $('#sel_div_asdfsafokmlv_dst').find('tr').each(function(index){
                    if(index != 0){
                        str += $(this).find('td').eq(3).text()+"\n";
                    }
                });
                $('#shield_host_list').html(str);

                $(this).dialog( "close" );
            },
            '取消': function() {
                $(this).dialog( "close" );
            }
        },
        close: function() {

        }
    });


});

function selectGroup(){
    $("#choose_host_group").hide();
    var val = $('input:radio[name="group_id"]:checked').val();
    $("#service_node").val(val);
}

