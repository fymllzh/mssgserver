$(function(){

    var operate;

    //选择机器
    $('.select-host').click(function(){
        $.ajax({
            url:"/api/host/items",
            data:{
                
            },
            type:'get',
            cache:false,
            dataType:'json',
            success:function(msg) {
                var tpl;

                tpl = '';
                tpl += '<div style="padding:5px 20px">';
                tpl += '<form action="" method="">';


                tpl += '<div class="form-group">';
                tpl += '<label for="search-name">机器名称</label>';
                tpl += '<input type="text" name="host_name" class="form-control"  value="">';
                tpl += '</div>';
                tpl += '<div class="form-group">';
                tpl += '<label>机器ip</label>';
                tpl += '<input type="text" name="ip" class="form-control" value="">';
                tpl += '</div>';
                tpl += '<input type="hidden" id="page" name="page" value="1">';
                tpl += '<button type="submit" id="submitSave" class="btn btn-success btn-bigger">搜索</button>';


                tpl += '<table class="table table-bordered table-hover">';
                tpl += '<thead>';
                tpl += '<tr>';
                tpl += '<th><input type="checkbox" id="checkAll" value="">全选</th>';
                tpl += '<th>ID</th>';
                tpl += '<th>机器名称</th>';
                tpl += '<th>IP</th>';
                tpl += '</tr>';
                tpl += '</thead>';
                tpl += '<tbody>';
                $(msg.data).each(function(index) {
                    tpl += '<tr id="tr_">';
                    tpl += '<td><input type="checkbox" name="host_id" value="'+msg.data[index].id+'"></td>';
                    tpl += '<td>'+msg.data[index].id+'</td>';
                    tpl += '<td>'+msg.data[index].host_name+'</td>';
                    tpl += '<td>'+msg.data[index].ip+'</td>';
                    tpl += '</tr>';
                });
                tpl += '</tbody>';
                tpl += '</table>';


                tpl += '<br><span id="error_info" style="color:red"></span>';
                tpl += '</form>';
                tpl += '</div>';

                return $(tpl).dialog({
                    slow: 'slide',
                    title: '选择机器',
                    width: 800,
                    height: 500,
                    open: function (event, ui) {
                        $(this).bind('keypress', function (event) {
                            if (event.keyCode === $.ui.keyCode.ENTER) {
                                $('.ui-dialog-buttonpane button').first().click();
                                return false;
                            }
                        });
                    },
                    buttons: {
                        '确认': function () {
                            return $(this).dialog('close');
                        },
                    }
                });

            },
            error : function() {
                alert("获取参数列表异常");
            }
        });
    });


    //机器列表
    $.ajax({
        url:"/api/host/items",
        data:{
            
        },
        type:'get',
        cache:false,
        dataType:'json',
        success:function(msg) {

            //SelectorView
            var sel = new SelectorView('sel_div');
            sel.src.header = {
                id			: 'Id',
                name		: '机器名称',
                name_cn		: 'IP地址'
            };
            sel.dst.header = {
                id			: 'Id',
                name		: '机器名称',
                name_cn		: 'IP地址'
            };
            sel.src.dataKey = 'id';
            sel.src.title = '机器列表';
            sel.src.display.filter = true;
            sel.src.display.pager = true;
            sel.src.pager.size = 30;
            sel.src.pager.maxButtons = 5;

            sel.dst.dataKey = 'id';
            sel.dst.title = '已选';
            sel.dst.pager.size = 10000;
            sel.dst.pager.maxButtons = 5;
            sel.dst.display.pager = true;

            sel.render();

            var arr = [];
            $(msg.data).each(function(index) {
                arr.push({id: msg.data[index].id, name: msg.data[index].host_name, name_cn: msg.data[index].ip});
            });
            sel.src.addRange(arr);
        },
        error : function() {
            alert("获取参数列表异常");
        }
    });


    //保存
    $('.save').click(function(){

        var param = {};
        var str = '';

        $('#sel_div_asdfsafokmlv_dst').find('tr').each(function(index){
            if(index != 0){
                str += $(this).find('td').eq(1).text()+',';
            }
        });

        param['host_ids'] = str;
        param['group_name'] = $('#group_name').val();

        $.ajax({
            url:"/api/hostgroup/create",
            data:param,
            type:"post",
            cache:false,
            dataType:"json",
            success:function(res){
                if(res.errno == 0){
                    $.apolloTip({
                        refresh: true,
                        tip: res.message,
                        closeTime: 1500
                    });
                    return window.location.href = "/html/host/group";
                }else{
                    return $.apolloTip({
                        refresh: false,
                        tip: res.message,
                        closeTime: 1500
                    });
                }
            },
            error : function() {
                alert("参数异常");
            }
        });
    });


    //表单
    $('.form-horizontal').ajaxForm({
        success: function(res) {
            if(res.errno == 0){
                $.apolloTip({
                    refresh: true,
                    tip: res.message,
                    closeTime: 1500
                });
                return window.location.href = "/html/group";
            }else{
                return $.apolloTip({
                    refresh: false,
                    tip: res.message,
                    closeTime: 1500
                });
            }
        }
    }, 'json');


    //全选
    $("#checkAll").click(function() {
        $('input[name="host_id"]').prop("checked",this.checked);
    });
    var $subBox = $("input[name='host_id']");
    $subBox.click(function(){
        if($subBox.length == $("input[name='host_id']:checked").length ){
            $("#checkAll").prop("checked",true);
        }else {
            $("#checkAll").removeAttr("checked",false);
        }
    });

});


function chooseHost(){
    var arr = {};
    $("input[name='host_id']:checkbox").each(function(index){
        if(this.checked){
            arr[index] = $(this).val()
        }
    });
}


function selecthost(){
    var appUrl = "/html/host?type=select_list";
    $.post(appUrl,function(result){
        $("#hostList").html(result);
    });
}