$(function(){

    $('.form-inline-body').ajaxForm({
        success: function(res) {
            if(res.errno == 0){
                alert(res.message);
                return window.location.href = "/html/group";
            }else{
                alert(res.message);
            }
        }
    }, 'json');
    //全选
    $("#checkAll").click(function() {
        $('input[name="host_id"]').prop("checked",this.checked);
    });
    var $subBox = $("input[name='host_id']");
    $subBox.click(function(){
        if($subBox.length == $("input[name='host_id']:checked").length ){
            $("#checkAll").prop("checked",true);
        }else {
            $("#checkAll").removeAttr("checked",false);
        }
    });



    //表单
    $('.form-horizontal').ajaxForm({
        success: function(res) {
            if(res.errno == 0){
                $.apolloTip({
                    refresh: true,
                    tip: res.message,
                    closeTime: 1500
                });
                return window.location.href = "/html/group";
            }else{
                return $.apolloTip({
                    refresh: false,
                    tip: res.message,
                    closeTime: 1500
                });
            }
        }
    }, 'json');


    //机器列表
    $.ajax({
        url:"/api/hostgroup/view",
        data:{
            'id':$('#group_id').val(),
        },
        type:'get',
        cache:false,
        dataType:'json',
        success:function(msg) {

            //SelectorView
            var sel = new SelectorView('sel_div');
            sel.src.header = {
                id			: 'Id',
                host_name	: '机器名称',
                ip		    : 'IP地址'
            };
            sel.dst.header = {
                id			: 'Id',
                host_name	: '机器名称',
                ip		    : 'IP地址'
            };
            sel.src.dataKey = 'id';
            sel.src.title = '机器列表';
            sel.src.display.filter = true;
            sel.src.display.pager = true;
            sel.src.pager.size = 30;
            sel.src.pager.maxButtons = 5;

            sel.dst.dataKey = 'id';
            sel.dst.title = '已选';
            sel.dst.pager.size = 10000;
            sel.dst.pager.maxButtons = 5;
            sel.dst.display.pager = true;

            sel.render();

            var srcArr = [];
            $(msg.srcList).each(function(index) {
                srcArr.push({
                    id: msg.srcList[index].id,
                    host_name: msg.srcList[index].host_name,
                    ip: msg.srcList[index].ip
                });
            });
            sel.src.addRange(srcArr);


            var dstArr = [];
            $(msg.dstList).each(function(index) {
                dstArr.push({
                    id: msg.dstList[index].id,
                    host_name: msg.dstList[index].host_name,
                    ip: msg.dstList[index].ip
                });
            });
            sel.dst.addRange(dstArr);

        },
        error : function() {
            alert("获取参数列表异常");
        }
    });


    //保存
    $('.save').click(function(){
        var param = {};
        var str = '';

        $('#sel_div_asdfsafokmlv_dst').find('tr').each(function(index){
            if(index != 0){
                str += $(this).find('td').eq(1).text()+',';
            }
        });

        param['group_id'] = $('#group_id').val();
        param['host_ids'] = str;
        param['group_name'] = $('#group_name').val();

        $.ajax({
            url:"/api/hostgroup/update",
            data:param,
            type:"post",
            cache:false,
            dataType:"json",
            success:function(res){
                if(res.errno == 0){
                    $.apolloTip({
                        refresh: true,
                        tip: res.message,
                        closeTime: 1500
                    });
                    return window.location.href = "/html/host/group";
                }else{
                    return $.apolloTip({
                        refresh: false,
                        tip: res.message,
                        closeTime: 1500
                    });
                }
            },
            error : function() {
                alert("参数异常");
            }
        });
    });





});



function chooseHost(){
    var str=$("#host_name").val();
    $("input[name='host_id']:checkbox").each(function(){
        if(this.checked){
            str += $(this).val()+","
        }
    });

    var arr = str.split(',');
    var new_arr=[];
    for(var i=0;i<arr.length;i++) {
        var items=arr[i];
        //判断元素是否存在于new_arr中，如果不存在则插入到new_arr的最后
        if($.inArray(items,new_arr)==-1) {
            new_arr.push(items);
        }
    }
    new_arr.pop();
    var new_str = '';
    for(var i=0;i<new_arr.length;i++){
        new_str += new_arr[i]+",";
    }

    $("#host_name").val(new_str);
}


function selecthost(){
    var appUrl = "/cttask/host/index?type=select_list";
    $.post(appUrl,function(result){
        $("#hostList").html(result);
    });
}