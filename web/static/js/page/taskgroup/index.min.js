(function() {
    $(function() {
        var operate;
        $('.delete').click(function() {
            return operate($(this), 'destroy');
        });

        $('.add').click(function(){
            var tpl,api;
            api = $(this).data('api');

            tpl = '';
            tpl += '<div style="padding:5px 20px">';
            tpl += '<form class="form-horizontal">';

            tpl += '<br><div class="form-group">';
            tpl += '<label class="col-sm-3"><span class="text-danger">*</span>分组名称:</label>';
            tpl += '<div class="col-sm-7">';
            tpl += '<input type="text" class="form-control" name="group_name" value="" placeholder="分组名称"> ';
            tpl += '</div>';
            tpl += '</div>';

            tpl += '<div class="form-group">';
            tpl += '<label class="col-sm-3"><span class="text-danger">*</span>分组描述:</label>';
            tpl += '<div class="col-sm-7">';
            tpl += '<input type="text" class="form-control" name="group_desc" value="" placeholder="分组描述"> ';
            tpl += '</div>';
            tpl += '</div>';

            tpl += '</form>';
            tpl += '</div>';

            return $(tpl).dialog({
                slow: 'slide',
                title: '添加分组',
                width: 400,
                height: 280,
                open: function (event, ui) {
                    $(this).bind('keypress', function (event) {
                        if (event.keyCode === $.ui.keyCode.ENTER) {
                            $('.ui-dialog-buttonpane button').first().click();
                            return false;
                        }
                    });
                },
                buttons: {
                    '确认': function () {
                        var data;
                        data = $(this).find('form').serialize();

                        return $.apolloAjaxTip({
                            url: api,
                            data: data,
                            type: 'POST',
                            closeTime: 1500
                        });
                    },
                    '取消': function () {
                        return $(this).dialog('close');
                    }
                }
            });
        });

        $('.edit').click(function(){
            var tpl, api, param;
            api = $(this).data('api');
            param = $(this).data('param');

            $.ajax({
                url:api,
                data:{
                    'id':param.id,
                },
                type:'get',
                cache:false,
                dataType:'json',
                success:function(msg) {

                    var task_group = msg.data;

                    tpl = '';
                    tpl += '<div style="padding:5px 20px">';
                    tpl += '<form class="form-horizontal">';
                    tpl += '<input type="hidden" name="id" value="'+param.id+'"> ';
                    tpl += '<br><div class="form-group">';
                    tpl += '<label class="col-sm-3"><span class="text-danger">*</span>分组名称:</label>';
                    tpl += '<div class="col-sm-7">';
                    tpl += '<input type="text" class="form-control" name="group_name" value="'+task_group.group_name+'" placeholder="分组名称"> ';
                    tpl += '</div>';
                    tpl += '</div>';
                    tpl += '<div class="form-group">';
                    tpl += '<label class="col-sm-3"><span class="text-danger">*</span>分组描述:</label>';
                    tpl += '<div class="col-sm-7">';
                    tpl += '<input type="text" class="form-control" name="group_desc" value="'+task_group.group_desc+'" placeholder="分组描述"> ';
                    tpl += '</div>';
                    tpl += '</div>';
                    tpl += '</form>';
                    tpl += '</div>';

                    return $(tpl).dialog({
                        slow: 'slide',
                        title: '添加分组',
                        width: 400,
                        height: 280,
                        open: function (event, ui) {
                            $(this).bind('keypress', function (event) {
                                if (event.keyCode === $.ui.keyCode.ENTER) {
                                    $('.ui-dialog-buttonpane button').first().click();
                                    return false;
                                }
                            });
                        },
                        buttons: {
                            '确认': function () {
                                var data;
                                data = $(this).find('form').serialize();
                                return $.apolloAjaxTip({
                                    url: '/api/taskgroup/update',
                                    data: data,
                                    type: 'POST',
                                    closeTime: 1500
                                });
                            },
                            '取消': function () {
                                return $(this).dialog('close');
                            }
                        }
                    });
                },
                error : function() {
                    alert("获取参数列表异常");
                }
            });
        });


        $('.operate').click(function(){
            var api, param, tpl, title;
            param = $(this).data('param');
            api = $(this).data('api');

            tpl = '';
            tpl += '<br><a href="" onclick="'+$(this).dialog('close')+'"></a><br>';
            tpl += '</div>';

            return $(tpl).dialog({
                slow: 'slide',
                title: title,
                width: 200,
                height: 240,
                open: function (event, ui) {
                    $(this).bind('keypress', function (event) {
                        if (event.keyCode === $.ui.keyCode.ENTER) {
                            $('.ui-dialog-buttonpane button').first().click();
                            return false;
                        }
                    });
                },
            });
        });

        return operate = function(opObj, method) {
            var param, tpl;
            param = opObj.data('param');
            tpl = '';
            tpl += '<div style="padding:5px 20px">';
            tpl += '<form method="POST" action="/cttask/task/delete">';
            tpl += '<div class="well">';
            tpl += '<p>确认 ' + opObj.text() + '? </p>';
            tpl += '</div>';
            tpl += '<input type="hidden" value="' + param.id + '" name="id"/>';
            tpl += '</form>';
            tpl += '</div>';
            return apollo.formDialog(tpl, {
                dialog: {
                    title: opObj.text()
                }
            });
        };





    });
}).call(this);

function selectOption(task_id){
    $("#modal-dialog-"+task_id).show();
    //var top =$("#selectbtn-"+task_id).offsetTop;
    //var divcss = {
    //top: top+'px',
    //};
    //$("#modal-dialog-"+task_id).css(divcss);
}
function closeOption(task_id){
    $("#modal-dialog-"+task_id).hide();
}
function runTask(task_action,task_id){
    var appUrl = "/cttask/task/task?task_action="+task_action+"&task_id="+task_id;
    $.post(appUrl,function(res){

        if(res.errno == 0){
            $("#modal-dialog-"+task_id).hide();
            $.apolloTip({
                refresh: true,
                tip: res.message,
                closeTime: 3500
            });
            return location.replace(location);
        }else{
            $("#modal-dialog-"+task_id).hide();
            var tpl;
            tpl = '';
            tpl += '<div style="padding:5px 20px">';
            tpl += '<p>'+res.message+'</p>'
            tpl += '</div>';

            return $(tpl).dialog({
                slow: 'slide',
                title: '错误',
                width: 800,
                height: 'auto',
                open: function (event, ui) {
                    $(this).bind('keypress', function (event) {
                        if (event.keyCode === $.ui.keyCode.ENTER) {
                            $('.ui-dialog-buttonpane button').first().click();
                            return false;
                        }
                    });
                },
                buttons: {
                    '取消': function () {
                        return $(this).dialog('close');
                    }
                }
            });


        }

    });
}